# 部署检查清单

本文档提供了一个完整的部署前、中、后检查清单，确保部署过程顺利进行。

## 🚀 部署前检查

### 环境准备

- [ ] **Node.js 版本**
  - [ ] Node.js 24.x 或更高版本已安装
  - [ ] 运行 `node --version` 确认版本

- [ ] **包管理器**
  - [ ] pnpm 已安装
  - [ ] 运行 `pnpm --version` 确认版本
  - [ ] 确认未使用 npm 或 yarn

- [ ] **系统资源**
  - [ ] 至少 2GB RAM 可用
  - [ ] 至少 5GB 磁盘空间可用
  - [ ] 5000 端口未被占用

### Supabase 配置

- [ ] **Supabase 项目**
  - [ ] 已创建 Supabase 项目
  - [ ] 项目处于活动状态
  - [ ] 记录 Project URL
  - [ ] 记录 anon public key
  - [ ] 记录 service_role key

- [ ] **环境变量**
  - [ ] 已复制 `.env.example` 为 `.env`
  - [ ] `NEXT_PUBLIC_SUPABASE_URL` 已配置
  - [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` 已配置
  - [ ] `SUPABASE_SERVICE_ROLE_KEY` 已配置（可选）
  - [ ] 验证环境变量格式正确

### 代码准备

- [ ] **代码库**
  - [ ] 代码已拉取到最新版本
  - [ ] 无未提交的更改（或确认更改可提交）
  - [ ] .gitignore 正确配置（忽略 .env、日志等）

- [ ] **依赖**
  - [ ] `package.json` 正确
  - [ ] `pnpm-lock.yaml` 存在
  - [ ] 无过期的依赖

### 数据库 Schema

- [ ] **Schema 同步**
  - [ ] 运行 `coze-coding-ai db upgrade` 同步 Schema
  - [ ] 验证所有表已创建
  - [ ] 运行 `node scripts/verify-supabase-tables.ts` 验证

## 📦 部署过程检查

### 依赖安装

- [ ] **安装成功**
  - [ ] 运行 `pnpm install` 成功
  - [ ] 无依赖冲突
  - [ ] 所有依赖正确安装

- [ ] **验证**
  - [ ] 运行 `pnpm list` 查看已安装依赖
  - [ ] 无缺失的核心依赖

### 构建过程

- [ ] **构建成功**
  - [ ] 运行 `pnpm run build` 成功
  - [ ] 无 TypeScript 错误
  - [ ] 无 ESLint 错误

- [ ] **构建产物**
  - [ ] `.next/` 目录已生成
  - [ ] 静态资源已优化
  - [ ] 构建大小合理

### 服务启动

- [ ] **清理旧进程**
  - [ ] 5000 端口已释放
  - [ ] 无旧服务残留

- [ ] **启动成功**
  - [ ] 服务启动命令执行成功
  - [ ] 进程正在运行
  - [ ] PID 文件已生成

- [ ] **端口监听**
  - [ ] 5000 端口正在监听
  - [ ] 使用 `ss -tuln | grep :5000` 确认

## ✅ 部署后验证

### 基础功能

- [ ] **HTTP 访问**
  - [ ] 主页可访问: `curl http://localhost:5000`
  - [ ] 返回 HTTP 200 状态码
  - [ ] 页面内容正常

- [ ] **健康检查**
  - [ ] 运行 `bash scripts/health-check.sh`
  - [ ] 所有检查项通过
  - [ ] 返回 "healthy" 状态

### 数据库连接

- [ ] **连接测试**
  - [ ] 运行 `node scripts/test-supabase-simple.ts`
  - [ ] 连接成功
  - [ ] 无权限错误

- [ ] **表访问**
  - [ ] 运行 `node scripts/verify-supabase-tables.ts`
  - [ ] 所有表可访问
  - [ ] 表结构正确

- [ ] **数据操作**
  - [ ] 运行 `node scripts/test-complete-service.ts`
  - [ ] CRUD 操作正常
  - [ ] 无错误返回

### 日志监控

- [ ] **日志文件**
  - [ ] 日志目录存在: `/app/work/logs/bypass/`
  - [ ] `app.log` 文件已生成
  - [ ] 日志正常输出

- [ ] **错误检查**
  - [ ] 无严重错误日志
  - [ ] 无未处理的异常
  - [ ] 警告信息合理

### 性能检查

- [ ] **资源使用**
  - [ ] CPU 使用率正常（< 80%）
  - [ ] 内存使用正常（< 2GB）
  - [ ] 磁盘 I/O 正常

- [ ] **响应时间**
  - [ ] 主页加载时间 < 2s
  - [ ] API 响应时间 < 500ms
  - [ ] 无明显卡顿

## 🔧 功能验证

### 核心功能

- [ ] **页面访问**
  - [ ] 首页正常显示
  - [ ] 静态资源加载成功
  - [ ] 无 404 错误

- [ ] **数据服务**
  - [ ] 数据查询正常
  - [ ] 数据写入正常
  - [ ] 数据更新正常

### API 端点

- [ ] **健康检查端点** (`/api/health`)
  - [ ] 返回 200 状态码
  - [ ] 返回正确的 JSON 格式

- [ ] **其他 API 端点**
  - [ ] 根据实际 API 列表验证
  - [ ] 返回正确的数据格式
  - [ ] 错误处理正常

## 🔒 安全检查

### 环境变量

- [ ] **敏感信息保护**
  - [ ] `.env` 文件未提交到 Git
  - [ ] `.env.example` 不包含真实密钥
  - [ ] `SUPABASE_SERVICE_ROLE_KEY` 不暴露给客户端

- [ ] **权限控制**
  - [ ] 数据库 RLS 策略已配置（如需要）
  - [ ] API 访问权限正确
  - [ ] CORS 配置正确

### 网络安全

- [ ] **端口安全**
  - [ ] 仅允许必要的端口访问
  - [ ] 防火墙规则已配置
  - [ ] 无未授权访问

## 📊 监控配置

### 日志监控

- [ ] **日志收集**
  - [ ] 应用日志正常输出
  - [ ] 错误日志已配置告警
  - [ ] 日志轮转策略已配置

### 性能监控

- [ ] **指标收集**
  - [ ] CPU 使用率监控
  - [ ] 内存使用监控
  - [ ] 磁盘空间监控
  - [ ] 网络流量监控

### 告警配置

- [ ] **告警规则**
  - [ ] 服务宕机告警
  - [ ] 错误率过高告警
  - [ ] 资源使用过高告警
  - [ ] 告警通知渠道已配置

## 📝 文档更新

- [ ] **部署文档**
  - [ ] 部署步骤已记录
  - [ ] 环境变量已记录
  - [ ] 常见问题已更新

- [ ] **变更日志**
  - [ ] 本次部署的变更已记录
  - [ ] 影响范围已评估
  - [ ] 回滚方案已准备

## 🚨 回滚准备

- [ ] **回滚方案**
  - [ ] 上一版本代码已备份
  - [ ] 数据库备份已创建
  - [ ] 回滚步骤已记录

- [ ] **回滚测试**
  - [ ] 回滚脚本已测试
  - [ ] 回滚时间估算
  - [ ] 回滚风险已评估

## ✅ 最终确认

### 部署确认

- [ ] 所有检查项已完成
- [ ] 无阻塞性问题
- [ ] 相关人员已通知
- [ ] 监控系统已启动
- [ ] 回滚方案已就绪

### 签署确认

- [ ] 部署负责人: _______________
- [ ] 测试负责人: _______________
- [ ] 运维负责人: _______________
- [ ] 部署时间: _______________
- [ ] 签署时间: _______________

---

## 📋 快速检查命令

```bash
# 环境检查
node --version
pnpm --version

# 端口检查
ss -tuln | grep :5000

# 进程检查
ps aux | grep "next start"

# 健康检查
bash scripts/health-check.sh

# 数据库测试
node scripts/test-supabase-simple.ts

# HTTP 测试
curl -I http://localhost:5000

# 日志检查
tail -n 50 /app/work/logs/bypass/app.log

# 错误检查
grep -i error /app/work/logs/bypass/app.log | tail -n 20
```

## 📞 问题报告模板

如果部署失败，请使用以下模板报告问题：

```
部署问题报告

部署环境:
- 环境: [开发/测试/生产]
- Node.js 版本: [版本号]
- 操作系统: [系统名称和版本]
- 部署时间: [时间]

问题描述:
- 问题现象: [描述]
- 错误信息: [贴出错误日志]
- 影响范围: [影响哪些功能]

已尝试的解决方案:
1. [方案1]
2. [方案2]
3. [方案3]

日志附件:
- [app.log 的最后 50 行]
- [dev.log 的相关部分]
```
