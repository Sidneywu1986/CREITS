# 金融数据实时更新使用指南

## 快速开始

### 1. 安装依赖

```bash
# 基础依赖
pnpm add node-cron axios ioredis socket.io socket.io-client

# 开发依赖
pnpm add -D @types/node-cron
```

### 2. 配置环境变量

创建 `.env.local` 文件：

```env
# 数据源配置
TUSHARE_TOKEN=your_tushare_token
EASTMONEY_API_KEY=your_eastmoney_key

# Redis配置
REDIS_URL=redis://localhost:6379

# WebSocket配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 3. 启动Redis

```bash
# 使用Docker
docker run -d -p 6379:6379 redis:alpine

# 或使用本地Redis
redis-server
```

### 4. 启动定时任务

```bash
# 创建启动脚本
pnpm run cron:server

# 或在开发环境中手动触发
curl -X POST http://localhost:5000/api/sync/quotes
```

### 5. 在组件中使用

```typescript
import { useRealtimeQuotes } from '@/hooks/useRealtimeQuotes';

export default function RealtimeQuotes() {
  const codes = ['508000', '508001', '508002'];
  const { quotes, connected, refreshQuotes } = useRealtimeQuotes(codes);

  return (
    <div>
      <div className="flex items-center gap-2 mb-4">
        <span className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`} />
        <span className="text-sm">
          {connected ? '实时连接中' : '连接断开'}
        </span>
        <button onClick={refreshQuotes} className="px-3 py-1 bg-blue-500 text-white rounded">
          刷新
        </button>
      </div>
      
      <table className="min-w-full border-collapse">
        <thead>
          <tr className="bg-gray-100">
            <th className="border p-2">代码</th>
            <th className="border p-2">名称</th>
            <th className="border p-2">价格</th>
            <th className="border p-2">涨跌幅</th>
          </tr>
        </thead>
        <tbody>
          {quotes.map(quote => (
            <tr key={quote.code}>
              <td className="border p-2">{quote.code}</td>
              <td className="border p-2">{quote.name}</td>
              <td className="border p-2">{quote.currentPrice.toFixed(2)}</td>
              <td className={`border p-2 ${quote.changePercent >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                {quote.changePercent >= 0 ? '+' : ''}{quote.changePercent.toFixed(2)}%
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

## API接口

### 1. 获取实时行情

```typescript
// GET /api/sync/quotes
// 返回当前实时行情数据

const response = await fetch('/api/sync/quotes');
const data = await response.json();
// { success: true, data: [...], count: 3 }
```

### 2. 手动触发同步

```typescript
// POST /api/sync/quotes
// 手动触发实时行情同步

const response = await fetch('/api/sync/quotes', {
  method: 'POST',
});
// { success: true, message: '实时行情同步已触发' }
```

### 3. 获取同步状态

```typescript
// GET /api/sync/status
// 获取同步任务状态和连接统计

const response = await fetch('/api/sync/status');
const data = await response.json();
// { 
//   success: true, 
//   data: {
//     tasks: { running: [...], timestamp: '...' },
//     update: { lastSync: '...', nextSync: '...', status: 'ok' },
//     websocket: { connected: 5, rooms: [...] }
//   }
// }
```

## 定时任务

### 任务列表

| 任务名称 | 执行时间 | 说明 |
|---------|---------|------|
| sync-quotes | 每5分钟（交易时间） | 同步实时行情 |
| sync-products | 每天8:00 | 同步产品列表 |
| sync-financial | 交易日15:30 | 同步财务数据 |
| sync-news | 每小时 | 同步新闻资讯 |
| check-status | 每10分钟 | 检查同步状态 |

### 手动触发任务

```typescript
import { dataSyncScheduler } from '@/lib/cron/scheduler';

// 触发行情同步
await dataSyncScheduler.triggerTask('sync-quotes');

// 触发产品列表同步
await dataSyncScheduler.triggerTask('sync-products');

// 触发财务数据同步
await dataSyncScheduler.triggerTask('sync-financial');

// 触发新闻同步
await dataSyncScheduler.triggerTask('sync-news');
```

## WebSocket连接

### 连接信息

- **URL**: `/api/socket`
- **协议**: WebSocket / Polling
- **事件**: 
  - `subscribe` - 订阅频道
  - `unsubscribe` - 取消订阅
  - `quote:update` - 单个行情更新
  - `quotes:update` - 批量行情更新
  - `news:update` - 新闻更新

### 订阅示例

```typescript
import { io } from 'socket.io-client';

const socket = io('/api/socket');

// 连接成功
socket.on('connect', () => {
  console.log('已连接');
  
  // 订阅特定产品行情
  socket.emit('subscribe', ['quote:508000', 'quote:508001']);
  
  // 订阅全部行情
  socket.emit('subscribe', 'quotes');
  
  // 订阅新闻
  socket.emit('subscribe', 'news');
});

// 接收行情更新
socket.on('quote:update', (quote) => {
  console.log('行情更新:', quote);
  // { code: '508000', currentPrice: 6.96, changePercent: 1.16, ... }
});

// 接收新闻更新
socket.on('news:update', (news) => {
  console.log('新闻更新:', news);
});

// 断开连接
socket.on('disconnect', () => {
  console.log('已断开');
});
```

## 数据缓存策略

### Redis缓存配置

| 数据类型 | 缓存键 | TTL（过期时间） | 说明 |
|---------|--------|---------------|------|
| 产品列表 | `reits:products:list` | 3600秒（1小时） | 产品基本信息 |
| 实时行情 | `quotes:realtime` | 5秒 | 实时行情数据 |
| 财务数据 | `financial:{code}:{period}` | 86400秒（1天） | 财务报表数据 |
| 新闻数据 | `news:list` | 600秒（10分钟） | 新闻资讯列表 |
| 同步时间 | `sync:last_time` | - | 最后同步时间戳 |

### 清除缓存

```typescript
import { dataSyncService } from '@/lib/services/data-sync-service';

// 清除产品列表缓存
await dataSyncService['redis'].del('reits:products:list');

// 清除实时行情缓存
await dataSyncService['redis'].del('quotes:realtime');

// 清除指定产品财务数据缓存
await dataSyncService['redis'].del('financial:508000:2024');
```

## 错误处理

### 常见错误

1. **Redis连接失败**
   - 检查Redis服务是否启动
   - 确认Redis URL配置正确

2. **Tushare API调用失败**
   - 检查TUSHARE_TOKEN是否正确
   - 确认API调用频率限制（每分钟200次）

3. **WebSocket连接失败**
   - 检查浏览器控制台错误信息
   - 确认WebSocket服务已启动

### 错误处理示例

```typescript
try {
  const response = await fetch('/api/sync/quotes');
  const data = await response.json();
  
  if (!data.success) {
    console.error('获取行情失败:', data.message);
    // 降级处理：显示缓存数据
    const cached = await getCachedQuotes();
    setQuotes(cached);
  } else {
    setQuotes(data.data);
  }
} catch (error) {
  console.error('网络错误:', error);
  // 降级处理：显示加载失败提示
  setError('无法加载实时数据');
}
```

## 监控和日志

### 查看同步日志

```bash
# 查看应用日志
tail -f logs/app.log

# 查看同步任务日志
grep "同步" logs/app.log

# 查看WebSocket日志
grep "WebSocket" logs/app.log
```

### 监控指标

```typescript
// 获取任务状态
const status = await fetch('/api/sync/status').then(r => r.json());

// 检查指标
console.log('任务运行中:', status.data.tasks.running);
console.log('最后同步时间:', status.data.update.lastSync);
console.log('WebSocket连接数:', status.data.websocket.connected);
console.log('数据同步状态:', status.data.update.status);
```

## 生产环境部署

### 1. 环境变量配置

```env
# 生产环境
REDIS_URL=redis://your-redis-host:6379
TUSHARE_TOKEN=production_token
NEXT_PUBLIC_APP_URL=https://your-domain.com
```

### 2. 使用PM2管理

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'reits-app',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    instances: 2,
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
    }
  }]
};
```

```bash
pm2 start ecosystem.config.js
pm2 logs reits-app
pm2 status
```

### 3. 使用Docker部署

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 5000

CMD ["npm", "start"]
```

```bash
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
  
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
```

```bash
docker-compose up -d
```

## 常见问题

### Q1: 如何获取Tushare Token？

A: 访问 https://tushare.pro 注册账号，在个人中心获取API Token。

### Q2: 数据更新频率是多少？

A: 
- 实时行情：每5秒更新（交易时间）
- 产品列表：每天8:00更新
- 财务数据：每个财报发布日更新
- 新闻资讯：每小时更新

### Q3: 如何支持更多数据源？

A: 在 `lib/services/data-sync-service.ts` 中添加新的API调用方法，并在定时任务中注册。

### Q4: 如何降低API调用成本？

A: 
- 合理设置缓存时间
- 使用Redis Pub/Sub减少重复查询
- 批量获取数据而非单条查询

## 相关文档

- [数据实时更新技术方案](./docs/数据实时更新方案.md)
- [Tushare API文档](https://tushare.pro/document/2)
- [Socket.IO文档](https://socket.io/docs/v4/)
- [Redis文档](https://redis.io/documentation)
