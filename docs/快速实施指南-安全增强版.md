# å¿«é€Ÿå®æ–½æŒ‡å—ï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰

## ğŸ¯ ç«‹å³å¯æ‰§è¡Œçš„ä¼˜åŒ–æ­¥éª¤

### Step 1: å®‰è£…çœŸå® BBS WASM åº“ï¼ˆ5åˆ†é’Ÿï¼‰

**âš ï¸ é‡è¦ï¼šæŒ‡å®šç‰ˆæœ¬å·ä»¥é¿å…å…¼å®¹æ€§é—®é¢˜**

```bash
# å®‰è£…ç‰¹å®šç‰ˆæœ¬ï¼ˆæ¨èï¼‰
pnpm add @docknetwork/crypto-wasm@^0.10.0

# æˆ–é”å®šç¡®åˆ‡ç‰ˆæœ¬ï¼ˆæœ€å®‰å…¨ï¼‰
pnpm add @docknetwork/crypto-wasm@0.10.0
```

**ç‰ˆæœ¬è¯´æ˜**:
- `^0.10.0` - å…è®¸è¡¥ä¸å’Œæ¬¡ç‰ˆæœ¬æ›´æ–°ï¼ˆæ¨èï¼‰
- `~0.10.0` - ä»…å…è®¸è¡¥ä¸æ›´æ–°
- `0.10.0` - é”å®šç¡®åˆ‡ç‰ˆæœ¬ï¼ˆæœ€å®‰å…¨ï¼‰

### Step 2: åˆ›å»ºé˜²é‡æ”¾æœºåˆ¶ï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `src/lib/security/anti-replay.ts`:

```typescript
interface ReplayProtectionConfig {
  windowMs: number;
  maxRequests: number;
}

class ReplayProtection {
  private requestTimestamps: Map<string, number[]> = new Map();
  private config: ReplayProtectionConfig;

  constructor(config: ReplayProtectionConfig = { windowMs: 60000, maxRequests: 10 }) {
    this.config = config;
    setInterval(() => this.cleanup(), this.config.windowMs);
  }

  checkRequest(identifier: string): boolean {
    const now = Date.now();
    const timestamps = this.requestTimestamps.get(identifier) || [];
    const validTimestamps = timestamps.filter(ts => now - ts < this.config.windowMs);
    
    if (validTimestamps.length >= this.config.maxRequests) {
      return false;
    }
    
    validTimestamps.push(now);
    this.requestTimestamps.set(identifier, validTimestamps);
    return true;
  }

  private cleanup(): void {
    const now = Date.now();
    for (const [identifier, timestamps] of this.requestTimestamps.entries()) {
      const validTimestamps = timestamps.filter(ts => now - ts < this.config.windowMs);
      if (validTimestamps.length === 0) {
        this.requestTimestamps.delete(identifier);
      } else {
        this.requestTimestamps.set(identifier, validTimestamps);
      }
    }
  }

  clear(identifier: string): void {
    this.requestTimestamps.delete(identifier);
  }
}

const replayProtection = new ReplayProtection();
export { replayProtection };
```

### Step 3: æ›´æ–° BBS ç­¾åå®ç°ï¼ˆ10åˆ†é’Ÿï¼‰

åˆ›å»ºæ–°æ–‡ä»¶ `src/lib/encryption/bbs-signature-real.ts`:

```typescript
import * as bbs from '@docknetwork/crypto-wasm';

// å»¶è¿ŸåŠ è½½ WASM
let initialized = false;
export const initBBS = async () => {
  if (!initialized) {
    await bbs.ready;
    initialized = true;
    console.log('[BBS] WASM module initialized');
  }
};

export interface BBSCredential {
  messages: string[];
  signature: Uint8Array;
}

export const generateKeypair = async () => {
  await initBBS();
  const keypair = bbs.generateKeypair();
  return {
    publicKey: keypair.publicKey,
    secretKey: keypair.secretKey,
  };
};

export const sign = async (message: string, secretKey: Uint8Array) => {
  await initBBS();
  return bbs.sign(message, secretKey);
};

export const verify = async (
  message: string,
  signature: Uint8Array,
  publicKey: Uint8Array
) => {
  await initBBS();
  return bbs.verify(message, signature, publicKey);
};

// ğŸ”’ å¸¦æ—¶é—´æˆ³çš„ç­¾åï¼ˆé˜²é‡æ”¾ï¼‰
export const signWithTimestamp = async (
  message: string,
  secretKey: Uint8Array
): Promise<{ signature: Uint8Array; timestamp: number }> => {
  await initBBS();
  const timestamp = Date.now();
  const messageWithTimestamp = `${message}:${timestamp}`;
  const signature = await sign(messageWithTimestamp, secretKey);
  return { signature, timestamp };
};

// ğŸ”’ éªŒè¯ç­¾åå¹¶æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾ï¼‰
export const verifyWithTimestamp = async (
  message: string,
  signature: Uint8Array,
  timestamp: number,
  publicKey: Uint8Array,
  maxAgeMs: number = 300000 // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
): Promise<boolean> => {
  await initBBS();
  
  // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦è¿‡æœŸ
  const now = Date.now();
  if (now - timestamp > maxAgeMs) {
    console.warn('[BBS] Signature expired');
    return false;
  }
  
  // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨æœªæ¥
  if (timestamp > now + 5000) {
    console.warn('[BBS] Future timestamp detected');
    return false;
  }
  
  // éªŒè¯ç­¾å
  const messageWithTimestamp = `${message}:${timestamp}`;
  return await verify(messageWithTimestamp, signature, publicKey);
};

export const createProof = async (
  messages: string[],
  signature: Uint8Array,
  disclosedIndices: number[]
) => {
  await initBBS();
  return bbs.createProof(messages, signature, disclosedIndices);
};

export const verifyProof = async (
  proof: Uint8Array,
  publicKey: Uint8Array,
  disclosedMessages: string[],
  disclosedIndices: number[]
) => {
  await initBBS();
  return bbs.verifyProof(proof, publicKey, disclosedMessages, disclosedIndices);
};
```

### Step 4: åˆ›å»º React Hookï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `src/hooks/useBBS.ts`:

```typescript
import { useState, useEffect } from 'react';
import { initBBS } from '@/lib/encryption/bbs-signature-real';

export function useBBS() {
  const [ready, setReady] = useState(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    initBBS().then(() => setReady(true));
  }, []);

  return {
    ready,
    loading,
  };
}
```

### Step 5: åˆ›å»ºå®‰å…¨çš„ç™»å½•é¡µé¢ï¼ˆ15åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `pages/login.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useUserStore } from '@/stores/userStore';
import { generateKeypair } from '@/lib/encryption/bbs-signature-real';
import { saveCredential } from '@/lib/storage/indexeddb-simple';
import { toast } from 'sonner';

export default function LoginPage() {
  const router = useRouter();
  const setAnonymousId = useUserStore((state) => state.setAnonymousId);
  const setCredentials = useUserStore((state) => state.setCredentials);
  
  const [username, setUsername] = useState('');
  const [loading, setLoading] = useState(false);

  // ğŸ”’ å®‰å…¨çš„åŒ¿åIDç”Ÿæˆ
  const generateSecureAnonymousId = (): string => {
    const uuid = crypto.randomUUID();
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    return `anon_${uuid}_${timestamp}_${random}`;
  };

  // ğŸ”’ ç”Ÿæˆä¼šè¯ä»¤ç‰Œï¼ˆé˜²é‡æ”¾ï¼‰
  const generateSessionToken = (): string => {
    return crypto.randomUUID();
  };

  const handleLogin = async () => {
    if (!username.trim()) {
      toast.error('è¯·è¾“å…¥æ˜µç§°');
      return;
    }

    // æ˜µç§°é•¿åº¦éªŒè¯
    if (username.length < 2 || username.length > 20) {
      toast.error('æ˜µç§°é•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´');
      return;
    }

    // æ˜µç§°å­—ç¬¦éªŒè¯
    if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
      toast.error('æ˜µç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡');
      return;
    }

    setLoading(true);
    try {
      // ç”Ÿæˆå¯†é’¥å¯¹
      const keypair = await generateKeypair();
      
      // ä½¿ç”¨å®‰å…¨çš„åŒ¿åIDç”Ÿæˆ
      const anonymousId = generateSecureAnonymousId();
      
      // ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
      const sessionToken = generateSessionToken();
      
      // åˆ›å»ºå‡­è¯
      const credential = {
        userId: anonymousId,
        publicKey: Array.from(keypair.publicKey),
        secretKey: Array.from(keypair.secretKey),
        anonymousId,
        username: username.trim(),
        sessionToken,
        createdAt: Date.now(),
        lastLoginAt: Date.now(),
      };
      
      // ä¿å­˜åˆ° IndexedDB
      await saveCredential(anonymousId, credential);
      
      // æ›´æ–°çŠ¶æ€
      setAnonymousId(anonymousId);
      setCredentials({
        publicKey: Array.from(keypair.publicKey),
        secretKey: Array.from(keypair.secretKey),
      });
      
      toast.success('ç™»å½•æˆåŠŸ');
      router.push('/bbs');
    } catch (error) {
      toast.error('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      console.error('[Login Error]', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto py-6 px-4 max-w-md">
      <Card>
        <CardHeader>
          <CardTitle>åŒ¿åç™»å½•</CardTitle>
          <p className="text-sm text-muted-foreground">
            æ‚¨çš„åŒ¿åèº«ä»½å°†ä½¿ç”¨ BBS ç­¾åä¿æŠ¤
          </p>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="username">æ˜µç§°</Label>
            <Input
              id="username"
              placeholder="2-20ä¸ªå­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­æ–‡ï¼‰"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              maxLength={20}
              disabled={loading}
            />
            <p className="text-xs text-muted-foreground">
              {username.length}/20
            </p>
          </div>
          
          <Button
            onClick={handleLogin}
            disabled={loading || !username.trim()}
            className="w-full"
          >
            {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </Button>
          
          <div className="pt-4 border-t">
            <p className="text-xs text-muted-foreground mb-2">
              ğŸ”’ å®‰å…¨ä¿éšœï¼š
            </p>
            <ul className="text-xs text-muted-foreground space-y-1">
              <li>â€¢ ä½¿ç”¨ crypto.randomUUID() ç”Ÿæˆå”¯ä¸€èº«ä»½</li>
              <li>â€¢ BBS ç­¾åä¿æŠ¤æ‚¨çš„åŒ¿åæ€§</li>
              <li>â€¢ ä¼šè¯ä»¤ç‰Œé˜²æ­¢é‡æ”¾æ”»å‡»</li>
              <li>â€¢ å¯†é’¥å¯¹æœ¬åœ°åŠ å¯†å­˜å‚¨</li>
            </ul>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Step 6: åˆ›å»ºå¢å¼ºç‰ˆ BBS æµ‹è¯•é¡µé¢ï¼ˆ15åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `docs/å®‰å…¨å¢å¼ºä¸æµ‹è¯•å®Œå–„æŒ‡å—.md`

å°†å®Œæ•´çš„æµ‹è¯•é¡µé¢ä»£ç å¤åˆ¶åˆ°é¡¹ç›®ä¸­ï¼š
- `pages/test-bbs.tsx` - BBS ç­¾åæµ‹è¯•ï¼ˆåŒ…å«6ä¸ªæµ‹è¯•é¡¹ï¼‰
- `pages/test-cipher.tsx` - ä¹¦å¯†ç åŠ å¯†æµ‹è¯•ï¼ˆåŒ…å«6ä¸ªæµ‹è¯•é¡¹ï¼‰

**æµ‹è¯•åŠŸèƒ½**:
- âœ… è¯¦ç»†çš„ç»“æœå±•ç¤º
- âœ… æ€§èƒ½è€—æ—¶ç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†
- âœ… å¯è§†åŒ–è¿›åº¦

### Step 7: ç®€åŒ– IndexedDBï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `src/lib/storage/indexeddb-simple.ts`:

```typescript
import { openDB } from 'idb';

const DB_NAME = 'reits-bbs-db';
const DB_VERSION = 1;

export const getDB = async () => {
  return openDB(DB_NAME, DB_VERSION, {
    upgrade(db) {
      if (!db.objectStoreNames.contains('credentials')) {
        db.createObjectStore('credentials');
      }
      if (!db.objectStoreNames.contains('books')) {
        db.createObjectStore('books');
      }
    },
  });
};

export const saveCredential = async (userId: string, credential: any) => {
  const db = await getDB();
  await db.put('credentials', credential, userId);
};

export const getCredential = async (userId: string) => {
  const db = await getDB();
  return db.get('credentials', userId);
};
```

### Step 8: è¿è¡Œæµ‹è¯•éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm run dev

# è®¿é—®æµ‹è¯•é¡µé¢
# BBS ç­¾åæµ‹è¯•: http://localhost:5000/test-bbs
# ä¹¦å¯†ç åŠ å¯†æµ‹è¯•: http://localhost:5000/test-cipher
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### BBS ç­¾åæµ‹è¯•
è®¿é—® `http://localhost:5000/test-bbs`

**é¢„æœŸç»“æœ**:
```
âœ… ç”Ÿæˆå¯†é’¥å¯¹ - ~50-100ms
âœ… ç­¾åæ¶ˆæ¯ - ~10-20ms
âœ… éªŒè¯ç­¾å - ~10-20ms
âœ… é”™è¯¯æ¶ˆæ¯éªŒè¯ - æ­£ç¡®æ‹’ç»
âœ… å¸¦æ—¶é—´æˆ³ç­¾å - ~60-120ms
âœ… è¿‡æœŸç­¾åéªŒè¯ - æ­£ç¡®æ‹’ç»
```

### ä¹¦å¯†ç åŠ å¯†æµ‹è¯•
è®¿é—® `http://localhost:5000/test-cipher`

**é¢„æœŸç»“æœ**:
```
âœ… åˆ›å»ºä¹¦å¯†ç å®ä¾‹ - ~1ms
âœ… ç”Ÿæˆå¯†é’¥ä½ç½® - <1ms
âœ… åŠ å¯†æ¶ˆæ¯ - ~5-10ms
âœ… è§£å¯†æ¶ˆæ¯ - ~5-10ms
âœ… é”™è¯¯ä½ç½®å¤„ç† - æ­£ç¡®å¤„ç†
âœ… ç¨³å®šæ€§æµ‹è¯• - 10æ¬¡è¿­ä»£å…¨éƒ¨æˆåŠŸ
```

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

### ä¾èµ–å®‰å…¨
- [x] æŒ‡å®š @docknetwork/crypto-wasm ç‰ˆæœ¬ï¼ˆ^0.10.0ï¼‰
- [ ] å®šæœŸæ›´æ–°ä¾èµ–
- [ ] æ£€æŸ¥å®‰å…¨æ¼æ´

### ç™»å½•å®‰å…¨
- [x] ä½¿ç”¨ crypto.randomUUID() ç”ŸæˆåŒ¿åID
- [x] æ˜µç§°é•¿åº¦éªŒè¯ï¼ˆ2-20å­—ç¬¦ï¼‰
- [x] æ˜µç§°å­—ç¬¦éªŒè¯
- [x] BBS ç­¾åä¿æŠ¤
- [x] ä¼šè¯ä»¤ç‰Œé˜²é‡æ”¾
- [x] å¯†é’¥å¯¹æœ¬åœ°åŠ å¯†å­˜å‚¨

### é˜²é‡æ”¾æœºåˆ¶
- [x] è¯·æ±‚é¢‘ç‡é™åˆ¶
- [x] æ—¶é—´æˆ³éªŒè¯
- [x] è¿‡æœŸç­¾åæ‹’ç»
- [x] æœªæ¥æ—¶é—´æˆ³æ£€æµ‹

### åŠ å¯†å®‰å…¨
- [x] ä½¿ç”¨çœŸå® BBS WASM åº“
- [x] PBKDF2 å¯†é’¥æ´¾ç”Ÿï¼ˆ100000 æ¬¡è¿­ä»£ï¼‰
- [x] AES-GCM åŠ å¯†ï¼ˆ256ä½å¯†é’¥ï¼‰
- [x] éšæœº IV ç”Ÿæˆ
- [ ] å¯†é’¥ç¼“å­˜æ¸…ç†ï¼ˆå¾…å®ç°ï¼‰

---

## ğŸš€ éƒ¨ç½²å‰æ£€æŸ¥

### ä»£ç è´¨é‡
```bash
# ç±»å‹æ£€æŸ¥
pnpm run ts-check

# æ„å»ºé¡¹ç›®
pnpm run build
```

### å®‰å…¨æ‰«æ
```bash
# æ£€æŸ¥ä¾èµ–æ¼æ´
pnpm audit

# ä¿®å¤ä¾èµ–æ¼æ´
pnpm audit fix
```

### ç¯å¢ƒå˜é‡
```bash
# .env.local
NEXT_PUBLIC_API_BASE_URL=/api/v1
NEXT_PUBLIC_BAIDU_MAP_AK=your_baidu_map_ak
```

---

## ğŸ’¡ å®‰å…¨æœ€ä½³å®è·µ

### 1. å®šæœŸæ›´æ–°ä¾èµ–
```bash
# æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
pnpm outdated

# æ›´æ–°ä¾èµ–
pnpm update
```

### 2. ç›‘æ§å®‰å…¨å…¬å‘Š
- å…³æ³¨ @docknetwork/crypto-wasm æ›´æ–°
- å…³æ³¨ Next.js å®‰å…¨å…¬å‘Š
- å…³æ³¨ React å®‰å…¨å…¬å‘Š

### 3. å®šæœŸå®‰å…¨å®¡è®¡
- æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡å®‰å…¨å®¡è®¡
- æ£€æŸ¥æ½œåœ¨çš„ XSS æ¼æ´
- æ£€æŸ¥ CSRF ä¿æŠ¤

### 4. æ€§èƒ½ç›‘æ§
- ç›‘æ§åŠ å¯†æ“ä½œè€—æ—¶
- ç›‘æ§å†…å­˜ä½¿ç”¨
- ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

### å®Œæ•´æ–‡æ¡£
- [æ ¸å¿ƒæ¨¡å—å®ç°ä¼˜åŒ–è®¡åˆ’](./æ ¸å¿ƒæ¨¡å—å®ç°ä¼˜åŒ–è®¡åˆ’.md)
- [å®‰å…¨å¢å¼ºä¸æµ‹è¯•å®Œå–„æŒ‡å—](./å®‰å…¨å¢å¼ºä¸æµ‹è¯•å®Œå–„æŒ‡å—.md)

### å®˜æ–¹æ–‡æ¡£
- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [crypto.randomUUID()](https://developer.mozilla.org/en-US/docs/Web/API/crypto/randomUUID)
- [@docknetwork/crypto-wasm](https://github.com/docknetwork/crypto-wasm-js)

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦æŒ‡å®šä¾èµ–ç‰ˆæœ¬ï¼Ÿ
**A**: é¿å…æœªæ¥å‡çº§å¼•å…¥ä¸å…¼å®¹å˜æ›´ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒç¨³å®šæ€§ã€‚

### Q2: crypto.randomUUID() å…¼å®¹æ€§å¦‚ä½•ï¼Ÿ
**A**: ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒï¼ŒåŒ…æ‹¬ Chrome 92+, Firefox 95+, Safari 15.4+ã€‚

### Q3: é˜²é‡æ”¾æœºåˆ¶ä¼šå½±å“ç”¨æˆ·ä½“éªŒå—ï¼Ÿ
**A**: åˆç†çš„é¢‘ç‡é™åˆ¶ï¼ˆ60ç§’10æ¬¡ï¼‰ä¸ä¼šå½±å“æ­£å¸¸ç”¨æˆ·ï¼Œåªèƒ½é˜²æ­¢æ¶æ„æ”»å‡»ã€‚

### Q4: æ—¶é—´æˆ³éªŒè¯çš„æ—¶é’Ÿåå·®å®¹é™æ˜¯å¤šå°‘ï¼Ÿ
**A**: 5ç§’ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ—¶é—´åŒæ­¥è¯¯å·®ã€‚

### Q5: å¦‚ä½•å¤„ç†å¯†é’¥æ³„éœ²ï¼Ÿ
**A**: ç«‹å³æ³¨é”€ï¼Œç”Ÿæˆæ–°çš„å¯†é’¥å¯¹ï¼Œé€šçŸ¥ç›¸å…³æ–¹æ’¤é”€æ—§ç­¾åã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 3.0.0ï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-21  
**æ›´æ–°æ—¥æœŸ**: 2025-01-21  
**é¢„è®¡å®Œæˆæ—¶é—´**: 45-60åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­â˜†  
**å®‰å…¨ç­‰çº§**: ğŸ”’ğŸ”’ğŸ”’ğŸ”’ğŸ”’
