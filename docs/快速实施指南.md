# å¿«é€Ÿå®æ–½æŒ‡å—

## ğŸ¯ ç«‹å³å¯æ‰§è¡Œçš„ä¼˜åŒ–æ­¥éª¤

### Step 1: å®‰è£…çœŸå® BBS WASM åº“ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# å®‰è£…ä¾èµ–
pnpm add @docknetwork/crypto-wasm
```

### Step 2: æ›´æ–° BBS ç­¾åå®ç°ï¼ˆ10åˆ†é’Ÿï¼‰

åˆ›å»ºæ–°æ–‡ä»¶ `src/lib/encryption/bbs-signature-real.ts`:

```typescript
import * as bbs from '@docknetwork/crypto-wasm';

// å»¶è¿ŸåŠ è½½ WASM
let initialized = false;
export const initBBS = async () => {
  if (!initialized) {
    await bbs.ready;
    initialized = true;
    console.log('[BBS] WASM module initialized');
  }
};

export interface BBSCredential {
  messages: string[];
  signature: Uint8Array;
}

export const generateKeypair = async () => {
  await initBBS();
  const keypair = bbs.generateKeypair();
  return {
    publicKey: keypair.publicKey,
    secretKey: keypair.secretKey,
  };
};

export const sign = async (message: string, secretKey: Uint8Array) => {
  await initBBS();
  return bbs.sign(message, secretKey);
};

export const verify = async (
  message: string,
  signature: Uint8Array,
  publicKey: Uint8Array
) => {
  await initBBS();
  return bbs.verify(message, signature, publicKey);
};

export const createProof = async (
  messages: string[],
  signature: Uint8Array,
  disclosedIndices: number[]
) => {
  await initBBS();
  return bbs.createProof(messages, signature, disclosedIndices);
};

export const verifyProof = async (
  proof: Uint8Array,
  publicKey: Uint8Array,
  disclosedMessages: string[],
  disclosedIndices: number[]
) => {
  await initBBS();
  return bbs.verifyProof(proof, publicKey, disclosedMessages, disclosedIndices);
};
```

### Step 3: åˆ›å»º React Hookï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `src/hooks/useBBS.ts`:

```typescript
import { useState, useEffect } from 'react';
import { initBBS } from '@/lib/encryption/bbs-signature-real';

export function useBBS() {
  const [ready, setReady] = useState(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    initBBS().then(() => setReady(true));
  }, []);

  return {
    ready,
    loading,
  };
}
```

### Step 4: æ›´æ–°ä¹¦å¯†ç åŠ å¯†ï¼ˆ10åˆ†é’Ÿï¼‰

ä¼˜åŒ– `src/lib/encryption/book-cipher.ts` ä¸­çš„å¯†é’¥æ´¾ç”Ÿ:

```typescript
private async deriveKey(keyStream: Uint8Array): Promise<CryptoKey> {
  // ä¼˜åŒ–ï¼šä½¿ç”¨å›ºå®šçš„ç›å€¼ï¼ˆå®é™…åº”ç”¨åº”è¯¥éšæœºï¼‰
  const salt = new TextEncoder().encode('REITs-BOOK-CIPHER-V2');
  
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    keyStream,
    'PBKDF2',
    false,
    ['deriveBits', 'deriveKey']
  );
  
  return crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt,
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}
```

### Step 5: ç®€åŒ– IndexedDBï¼ˆ5åˆ†é’Ÿï¼‰

åˆ›å»ºç®€åŒ–ç‰ˆ `src/lib/storage/indexeddb-simple.ts`:

```typescript
import { openDB } from 'idb';

const DB_NAME = 'reits-bbs-db';
const DB_VERSION = 1;

export const getDB = async () => {
  return openDB(DB_NAME, DB_VERSION, {
    upgrade(db) {
      if (!db.objectStoreNames.contains('credentials')) {
        db.createObjectStore('credentials');
      }
      if (!db.objectStoreNames.contains('books')) {
        db.createObjectStore('books');
      }
    },
  });
};

export const saveCredential = async (userId: string, credential: any) => {
  const db = await getDB();
  await db.put('credentials', credential, userId);
};

export const getCredential = async (userId: string) => {
  const db = await getDB();
  return db.get('credentials', userId);
};
```

### Step 6: ä¼˜åŒ– API å®¢æˆ·ç«¯ï¼ˆ5åˆ†é’Ÿï¼‰

åœ¨ `src/lib/api/client.ts` ä¸­æ·»åŠ é‡è¯•é€»è¾‘:

```typescript
// æ·»åŠ é‡è¯•é…ç½®
const MAX_RETRIES = 3;
const RETRY_DELAY = 1000;

async function fetchWithRetry(
  url: string,
  options: RequestInit,
  retries = MAX_RETRIES
): Promise<Response> {
  try {
    const response = await fetch(url, options);
    if (!response.ok && retries > 0) {
      throw new Error(`Request failed: ${response.status}`);
    }
    return response;
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
      return fetchWithRetry(url, options, retries - 1);
    }
    throw error;
  }
}

// æ›´æ–° get æ–¹æ³•
async get<T>(url: string, config?: RequestInit): Promise<T> {
  const headers = await getAuthHeaders();
  const response = await fetchWithRetry(
    `${API_BASE}${url}`,
    { ...config, headers }
  );
  if (!response.ok) throw new Error(await response.text());
  return response.json();
}
```

### Step 7: ä¼˜åŒ–ç”¨æˆ· Storeï¼ˆ5åˆ†é’Ÿï¼‰

åœ¨ `src/stores/userStore.ts` ä¸­æ·»åŠ  Selector:

```typescript
// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 
export const selectAnonymousId = (state: UserState) => state.anonymousId;
export const selectPoints = (state: UserState) => state.points;
export const selectIsLoggedIn = (state: UserState) => state.isLoggedIn;

// ä½¿ç”¨ç¤ºä¾‹
const anonymousId = useUserStore(selectAnonymousId);
const points = useUserStore(selectPoints);
```

### Step 8: åˆ›å»ºç™»å½•é¡µé¢ï¼ˆ10åˆ†é’Ÿï¼‰

åˆ›å»ºæ–‡ä»¶ `pages/login.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useUserStore } from '@/stores/userStore';
import { generateKeypair } from '@/lib/encryption/bbs-signature-real';
import { saveCredential } from '@/lib/storage/indexeddb-simple';
import { toast } from 'sonner';

export default function LoginPage() {
  const router = useRouter();
  const setAnonymousId = useUserStore((state) => state.setAnonymousId);
  const setCredentials = useUserStore((state) => state.setCredentials);
  
  const [username, setUsername] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    if (!username.trim()) {
      toast.error('è¯·è¾“å…¥æ˜µç§°');
      return;
    }

    setLoading(true);
    try {
      // ç”Ÿæˆå¯†é’¥å¯¹
      const keypair = await generateKeypair();
      const anonymousId = `user_${Date.now()}_${Math.random().toString(36).substring(2)}`;
      
      // ä¿å­˜åˆ° IndexedDB
      await saveCredential(anonymousId, {
        userId: anonymousId,
        publicKey: keypair.publicKey,
        secretKey: keypair.secretKey,
        anonymousId,
      });
      
      // æ›´æ–°çŠ¶æ€
      setAnonymousId(anonymousId);
      setCredentials({
        publicKey: keypair.publicKey,
        secretKey: keypair.secretKey,
      });
      
      toast.success('ç™»å½•æˆåŠŸ');
      router.push('/bbs');
    } catch (error) {
      toast.error('ç™»å½•å¤±è´¥');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto py-6 px-4 max-w-md">
      <Card>
        <CardHeader>
          <CardTitle>åŒ¿åç™»å½•</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="username">æ˜µç§°</Label>
            <Input
              id="username"
              placeholder="è¯·è¾“å…¥æ˜µç§°"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
            />
          </div>
          <Button
            onClick={handleLogin}
            disabled={loading}
            className="w-full"
          >
            {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </Button>
          <p className="text-sm text-muted-foreground text-center">
            ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ BBS å¯†é’¥å¯¹ï¼Œä¿æŠ¤æ‚¨çš„åŒ¿åèº«ä»½
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰

### æµ‹è¯• 1: BBS ç­¾ååŠŸèƒ½

åˆ›å»ºæ–‡ä»¶ `pages/test-bbs.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useBBS } from '@/hooks/useBBS';
import { generateKeypair, sign, verify } from '@/lib/encryption/bbs-signature-real';

export default function TestBBSPage() {
  const { ready } = useBBS();
  const [result, setResult] = useState('');

  const handleTest = async () => {
    try {
      // ç”Ÿæˆå¯†é’¥å¯¹
      const keypair = await generateKeypair();
      
      // ç­¾å
      const message = 'Hello, BBS!';
      const signature = await sign(message, keypair.secretKey);
      
      // éªŒè¯
      const isValid = await verify(message, signature, keypair.publicKey);
      
      setResult(`âœ… ç­¾åéªŒè¯æˆåŠŸ: ${isValid}`);
    } catch (error) {
      setResult(`âŒ é”™è¯¯: ${error}`);
    }
  };

  return (
    <div className="container mx-auto py-6 px-4 max-w-md">
      <Card>
        <CardHeader>
          <CardTitle>BBS ç­¾åæµ‹è¯•</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p>WASM çŠ¶æ€: {ready ? 'âœ… å·²å°±ç»ª' : 'â³ åŠ è½½ä¸­...'}</p>
          </div>
          <Button onClick={handleTest} disabled={!ready}>
            æµ‹è¯•ç­¾ååŠŸèƒ½
          </Button>
          {result && <p>{result}</p>}
        </CardContent>
      </Card>
    </div>
  );
}
```

### æµ‹è¯• 2: ä¹¦å¯†ç åŠ å¯†

åˆ›å»ºæ–‡ä»¶ `pages/test-cipher.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { BookCipher } from '@/lib/encryption/book-cipher';

export default function TestCipherPage() {
  const [result, setResult] = useState('');

  const handleTest = async () => {
    try {
      // åˆ›å»ºä¹¦å¯†ç å®ä¾‹
      const bookContent = 'è¿™æ˜¯ä¸€æœ¬ä¹¦çš„å†…å®¹ï¼Œç”¨äºç”Ÿæˆå¯†é’¥ã€‚'.repeat(100);
      const cipher = new BookCipher(bookContent);
      
      // åŠ å¯†
      const plaintext = 'è¿™æ˜¯ä¸€æ¡ç§˜å¯†æ¶ˆæ¯';
      const startPos = cipher.generateStartPos();
      const ciphertext = await cipher.encrypt(plaintext, startPos);
      
      // è§£å¯†
      const decrypted = await cipher.decrypt(ciphertext, startPos, plaintext.length);
      
      setResult(
        `âœ… åŠ å¯†/è§£å¯†æˆåŠŸ!\nåŸæ–‡: ${plaintext}\nè§£å¯†: ${decrypted}\nåŒ¹é…: ${plaintext === decrypted}`
      );
    } catch (error) {
      setResult(`âŒ é”™è¯¯: ${error}`);
    }
  };

  return (
    <div className="container mx-auto py-6 px-4 max-w-md">
      <Card>
        <CardHeader>
          <CardTitle>ä¹¦å¯†ç åŠ å¯†æµ‹è¯•</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <Button onClick={handleTest}>æµ‹è¯•åŠ å¯†åŠŸèƒ½</Button>
          {result && <pre className="whitespace-pre-wrap">{result}</pre>}
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### å¼€å‘ç¯å¢ƒæ£€æŸ¥
- [ ] Node.js 24 å·²å®‰è£…
- [ ] pnpm 9.0.0 å·²å®‰è£…
- [ ] Next.js 16.1.1 å·²é…ç½®
- [ ] TypeScript 5 å·²é…ç½®

### ä¾èµ–æ£€æŸ¥
- [ ] @docknetwork/crypto-wasm å·²å®‰è£…
- [ ] idb å·²å®‰è£…
- [ ] zustand å·²å®‰è£…
- [ ] @tanstack/react-query å·²å®‰è£…

### åŠŸèƒ½æ£€æŸ¥
- [ ] BBS ç­¾ååŠŸèƒ½æ­£å¸¸
- [ ] ä¹¦å¯†ç åŠ å¯†åŠŸèƒ½æ­£å¸¸
- [ ] IndexedDB å­˜å‚¨æ­£å¸¸
- [ ] API å®¢æˆ·ç«¯æ­£å¸¸
- [ ] ç”¨æˆ·çŠ¶æ€ç®¡ç†æ­£å¸¸

### æµè§ˆå™¨æµ‹è¯•
- [ ] Chrome (æœ€æ–°ç‰ˆ)
- [ ] Firefox (æœ€æ–°ç‰ˆ)
- [ ] Safari (æœ€æ–°ç‰ˆ)
- [ ] Edge (æœ€æ–°ç‰ˆ)

---

## ğŸš€ éƒ¨ç½²å‰æ£€æŸ¥

### æ„å»ºæ£€æŸ¥
```bash
# ç±»å‹æ£€æŸ¥
pnpm run ts-check

# æ„å»ºé¡¹ç›®
pnpm run build

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
pnpm run start
```

### ç¯å¢ƒå˜é‡æ£€æŸ¥
```bash
# .env.local
NEXT_PUBLIC_API_BASE_URL=/api/v1
NEXT_PUBLIC_BAIDU_MAP_AK=your_baidu_map_ak
```

### æ€§èƒ½æ£€æŸ¥
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 2s
- [ ] FCP < 1.5s
- [ ] LCP < 2.5s
- [ ] TTI < 3s

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Next.js æ–‡æ¡£](https://nextjs.org/docs)
- [React æ–‡æ¡£](https://react.dev)
- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/docs)
- [shadcn/ui æ–‡æ¡£](https://ui.shadcn.com)

### åŠ å¯†ç›¸å…³
- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [@docknetwork/crypto-wasm](https://github.com/docknetwork/crypto-wasm-js)
- [IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)

### çŠ¶æ€ç®¡ç†
- [Zustand æ–‡æ¡£](https://zustand-demo.pmnd.rs)
- [TanStack Query æ–‡æ¡£](https://tanstack.com/query/latest)

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: WASM æ¨¡å—åŠ è½½å¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥ `next.config.js` ä¸­çš„ WASM é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

### Q2: IndexedDB æ•°æ®ä¸¢å¤±ï¼Ÿ
**A**: ç¡®ä¿æµè§ˆå™¨æœªæ¸…é™¤æ•°æ®ï¼Œä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ã€‚

### Q3: BBS ç­¾åéªŒè¯å¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥å…¬é’¥å’Œç§é’¥æ˜¯å¦åŒ¹é…ï¼Œç¡®ä¿ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯ã€‚

### Q4: API è¯·æ±‚è¶…æ—¶ï¼Ÿ
**A**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°å’Œè¶…æ—¶æ—¶é—´ã€‚

### Q5: ç§¯åˆ†ä¸æ›´æ–°ï¼Ÿ
**A**: æ£€æŸ¥ Zustand persist é…ç½®ï¼Œç¡®ä¿ localStorage æ­£å¸¸å·¥ä½œã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-21  
**é¢„è®¡å®Œæˆæ—¶é—´**: 30-45åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â˜†â˜†
