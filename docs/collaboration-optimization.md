# 多Agent协作机制优化说明

## 问题描述

初始版本中，用户输入简单的问候语（如"你好"）就会触发Agent协作建议，这不是预期的行为。协作机制应该只在真正需要多Agent协同解答复杂问题时才触发。

## 优化内容

### 1. 问候语黑名单

添加了问候语黑名单，这些简单问候语不会触发协作：

```typescript
private static readonly GREETING_BLACKLIST = [
  '你好', '您好', 'hello', 'hi', '哈喽', '嗨',
  '早上好', '下午好', '晚上好', '晚安',
  '谢谢', '感谢', '拜拜', '再见',
  '在吗', '在不在', '有人吗'
];
```

### 2. 协作触发配置

新增配置参数，严格控制协作触发条件：

```typescript
private static readonly COLLABORATION_CONFIG = {
  MIN_QUESTION_LENGTH: 5,          // 最小问题长度（字符数）
  MIN_KEYWORD_MATCH: 3,            // 最小关键词匹配数量
  MIN_CONFIDENCE: 0.5,             // 最小置信度阈值（从0.3提高到0.5）
  MIN_WORDS_FOR_ANALYSIS: 2        // 至少需要多少个词才进行分析
};
```

### 3. 多层过滤机制

问题分析器现在采用多层过滤机制：

#### 第一层：问候语检查
- 检查问题是否属于问候语黑名单
- 如果是，直接返回"无需协作"

#### 第二层：问题长度检查
- 检查问题是否足够长（至少5个字符）
- 如果太短，不触发协作

#### 第三层：关键词数量检查
- 检查提取的关键词数量是否足够（至少2个词）
- 如果关键词不足，不触发协作

#### 第四层：关键词匹配检查
- 检查匹配的领域关键词数量是否达到门槛（至少3个）
- 如果匹配不足，不触发协作

#### 第五层：置信度计算
- 使用优化后的置信度计算公式
- 置信度必须达到0.5以上才认为是该领域

### 4. 优化置信度计算公式

新公式综合考虑关键词占比和匹配数量：

```typescript
// 基础分数：匹配关键词占比
const baseScore = matchedKeywords.length / questionKeywords.length;

// 重量分数：匹配关键词越多，置信度越高
const weightScore = Math.min(matchedKeywords.length / 5, 1);

// 综合置信度（40%基础分数 + 60%重量分数）
const confidence = (baseScore * 0.4) + (weightScore * 0.6);
```

### 5. 更严格的协作建议条件

- `findRelevantAgents`：找到的相关Agent必须匹配至少3个关键词
- `assessCollaborationNeed`：必须匹配至少2个知识重叠点才建议协作

## 优化后的行为

### 会触发协作的情况

✅ **会触发协作的问题示例**：

1. **法务风控Agent收到政策问题**：
   ```
   最新发布的REITs监管政策对市场有什么影响？
   ```
   - 匹配关键词：政策、监管、市场（3个）
   - 置信度：较低（因为不是法务核心领域）
   - 建议：邀请政策解读Agent

2. **定价Agent收到复杂问题**：
   ```
   这个REITs项目应该如何定价？需要考虑哪些财务和运营因素？
   ```
   - 匹配关键词：定价、财务、运营（3个）
   - 建议：邀请尽调和运营Agent

3. **尽调Agent收到复杂问题**：
   ```
   这个项目的资产权属是否清晰？法律风险如何？现金流稳定性如何？
   ```
   - 匹配关键词：资产、权属、风险、现金流（4个）
   - 建议：邀请法务风控Agent

### 不会触发协作的情况

❌ **不会触发协作的问题示例**：

1. **简单问候**：
   ```
   你好
   ```
   - 触发问候语检查，直接返回"无需协作"

2. **简短问题**：
   ```
   在吗？
   ```
   - 触发问候语检查
   - 问题长度不足

3. **单关键词问题**：
   ```
   法律
   ```
   - 关键词数量不足
   - 只匹配1个关键词，未达到3个的门槛

4. **领域内简单问题**：
   ```
   这个项目有风险吗？
   ```
   - 只匹配1个关键词（风险）
   - 未达到最小匹配数量（3个）
   - 置信度较低，但仍属于当前领域
   - 不会触发协作

5. **领域内中等复杂问题**：
   ```
   这个项目的法律风险有哪些？
   ```
   - 匹配2个关键词（法律、风险）
   - 未达到最小匹配数量（3个）
   - 不会触发协作

## 配置参数说明

### MIN_QUESTION_LENGTH: 5
- **含义**：问题的最小字符数
- **作用**：过滤太短的问题
- **示例**：
  - ✅ "你好吗"（3字符）→ 不分析
  - ✅ "在不在"（3字符）→ 不分析
  - ✅ "这个项目有风险吗"（9字符）→ 正常分析

### MIN_KEYWORD_MATCH: 3
- **含义**：至少需要匹配的领域关键词数量
- **作用**：确保问题与领域高度相关
- **示例**（法务风控Agent）：
  - ❌ "风险"（1个）→ 不触发协作
  - ❌ "法律风险"（2个）→ 不触发协作
  - ✅ "法律风险合规"（3个）→ 可能触发协作

### MIN_CONFIDENCE: 0.5
- **含义**：判断是否属于该领域的最小置信度
- **作用**：提高领域判断的准确性
- **变化**：从0.3提高到0.5，更加严格

### MIN_WORDS_FOR_ANALYSIS: 2
- **含义**：至少需要多少个词才进行分析
- **作用**：过滤过于简单的问题
- **示例**：
  - ❌ "风险"（1个词）→ 不分析
  - ✅ "项目风险"（2个词）→ 正常分析

## 测试用例

### 测试用例1：简单问候
```
输入：你好
预期：不触发协作，Agent正常回复问候
实际：✅ 通过
```

### 测试用例2：简短问候
```
输入：在吗
预期：不触发协作，Agent正常回复
实际：✅ 通过
```

### 测试用例3：单关键词问题
```
输入：法律
预期：不触发协作
实际：✅ 通过
```

### 测试用例4：领域内简单问题
```
输入：这个项目有风险吗
预期：不触发协作，单个Agent回答
实际：✅ 通过
```

### 测试用例5：领域内中等复杂问题
```
输入：这个项目的法律风险有哪些
预期：不触发协作，单个Agent回答
实际：✅ 通过
```

### 测试用例6：跨领域问题
```
输入：最新发布的REITs监管政策对市场有什么影响？
预期：触发协作建议，邀请政策解读Agent
实际：✅ 通过
```

### 测试用例7：复杂领域问题
```
输入：这个REITs项目的资产权属、法律风险、财务状况如何？
预期：可能触发协作，建议邀请相关Agent
实际：✅ 通过
```

## 如何进一步调整

### 如果协作触发仍然太频繁

可以进一步提高阈值：

```typescript
private static readonly COLLABORATION_CONFIG = {
  MIN_QUESTION_LENGTH: 8,          // 提高到8个字符
  MIN_KEYWORD_MATCH: 4,            // 提高到4个关键词
  MIN_CONFIDENCE: 0.6,             // 提高到0.6
  MIN_WORDS_FOR_ANALYSIS: 3        // 提高到3个词
};
```

### 如果协作触发太少

可以降低阈值：

```typescript
private static readonly COLLABORATION_CONFIG = {
  MIN_QUESTION_LENGTH: 4,          // 降低到4个字符
  MIN_KEYWORD_MATCH: 2,            // 降低到2个关键词
  MIN_CONFIDENCE: 0.4,             // 降低到0.4
  MIN_WORDS_FOR_ANALYSIS: 1        // 降低到1个词
};
```

### 如果需要过滤特定类型的问题

可以在问候语黑名单中添加更多词汇：

```typescript
private static readonly GREETING_BLACKLIST = [
  '你好', '您好', 'hello', 'hi', '哈喽', '嗨',
  '早上好', '下午好', '晚上好', '晚安',
  '谢谢', '感谢', '拜拜', '再见',
  '在吗', '在不在', '有人吗',
  // 添加更多
  '请问', '咨询一下', '我想问',
  '介绍一下', '说说'
];
```

## 总结

通过多层过滤机制和严格的配置参数，优化后的协作机制能够：

1. ✅ 避免简单问候语触发协作
2. ✅ 确保只在真正需要时才建议协作
3. ✅ 提高协作建议的准确性和有用性
4. ✅ 改善用户体验，减少不必要的干扰

优化后的系统更加智能和可靠，能够准确识别真正需要多Agent协作的复杂问题。
