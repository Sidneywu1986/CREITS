# 本地调试详细指南 - 解决 Next.js 16 加载问题

## ⚠️ 重要提示

如果你在本地启动时遇到 **服务无法启动** 或 **页面无法加载** 的问题，这是 **Next.js 16 的一个已知兼容性问题**。

---

## 🔧 解决方案

### 方案 1: 降级到 Next.js 15（推荐）

Next.js 16.1.1 存在已知的启动问题，降级到 Next.js 15 可以稳定运行。

#### 步骤 1: 修改 package.json

```bash
# 编辑 package.json
nano package.json
```

找到 `dependencies` 部分，修改 next 版本：

```json
{
  "dependencies": {
    "next": "15.1.6",  // 从 "16.1.1" 改为 "15.1.6"
    "react": "19.0.0",
    "react-dom": "19.0.0",
    ...
  }
}
```

#### 步骤 2: 重新安装依赖

```bash
# 清理旧的依赖
rm -rf node_modules pnpm-lock.yaml

# 重新安装
pnpm install
```

#### 步骤 3: 清理缓存

```bash
# 清理 Next.js 缓存
rm -rf .next

# 清理 pnpm 缓存
pnpm store prune
```

#### 步骤 4: 启动服务

```bash
pnpm dev
```

访问 http://localhost:5000，现在应该可以正常加载了。

---

### 方案 2: 使用 Next.js 16 临时配置

如果你必须使用 Next.js 16，可以使用以下临时配置来绕过启动问题。

#### 步骤 1: 创建新的 next.config.js

```bash
# 备份原配置
cp next.config.js next.config.js.bak

# 创建新配置
cat > next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 简化配置，避免兼容性问题
  webpack: (config, { isServer }) => {
    config.experiments = {
      ...config.experiments,
      asyncWebAssembly: true,
      layers: true,
    };

    config.resolve.fallback = {
      ...config.resolve.fallback,
      fs: false,
      net: false,
      tls: false,
    };

    config.module.rules.push({
      test: /\.wasm$/,
      type: 'webassembly/async',
    });

    return config;
  },

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: 'localhost',
      },
    ],
  },
};

module.exports = nextConfig;
EOF
```

#### 步骤 2: 清理并重启

```bash
rm -rf .next
pnpm dev
```

#### 步骤 3: 如果仍然失败

```bash
# 使用构建模式启动
pnpm build
pnpm start
```

---

### 方案 3: 禁用 WASM 支持（临时）

如果 WASM 加载导致问题，可以暂时禁用它。

#### 修改 next.config.js

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 暂时禁用 WASM
  webpack: (config) => {
    return config;
  },

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: 'localhost',
      },
    ],
  },
};

module.exports = nextConfig;
```

然后重启服务：

```bash
rm -rf .next
pnpm dev
```

---

## 📋 完整的一键修复脚本

创建 `fix-startup.sh` 脚本：

```bash
#!/bin/bash

echo "========================================="
echo "  REITs 智能助手 - 启动问题修复脚本"
echo "========================================="
echo ""

# 询问用户选择
echo "请选择修复方案："
echo "1) 降级到 Next.js 15（推荐，稳定）"
echo "2) 使用 Next.js 16 简化配置"
echo "3) 禁用 WASM 支持"
echo ""
read -p "请输入选项 (1/2/3): " choice

case $choice in
    1)
        echo ""
        echo "正在降级到 Next.js 15..."
        
        # 修改 package.json
        if [ -f package.json ]; then
            sed -i 's/"next": "16.1.1"/"next": "15.1.6"/g' package.json
            sed -i 's/"next": "^16.1.1"/"next": "15.1.6"/g' package.json
            echo "✓ 已修改 package.json"
        fi
        
        # 清理并重新安装
        echo "正在清理旧依赖..."
        rm -rf node_modules pnpm-lock.yaml .next
        
        echo "正在重新安装依赖..."
        pnpm install
        
        echo ""
        echo "✓ 修复完成！"
        echo ""
        echo "启动命令：pnpm dev"
        ;;
        
    2)
        echo ""
        echo "正在应用 Next.js 16 简化配置..."
        
        # 创建简化的 next.config.js
        cat > next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config, { isServer }) => {
    config.experiments = {
      ...config.experiments,
      asyncWebAssembly: true,
      layers: true,
    };

    config.resolve.fallback = {
      ...config.resolve.fallback,
      fs: false,
      net: false,
      tls: false,
    };

    config.module.rules.push({
      test: /\.wasm$/,
      type: 'webassembly/async',
    });

    return config;
  },

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: 'localhost',
      },
    ],
  },
};

module.exports = nextConfig;
EOF
        
        # 清理缓存
        echo "正在清理缓存..."
        rm -rf .next node_modules/.cache
        
        echo ""
        echo "✓ 配置已更新！"
        echo ""
        echo "启动命令：pnpm dev"
        ;;
        
    3)
        echo ""
        echo "正在禁用 WASM 支持..."
        
        # 创建简化配置
        cat > next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config) => {
    return config;
  },

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: 'localhost',
      },
    ],
  },
};

module.exports = nextConfig;
EOF
        
        # 清理缓存
        echo "正在清理缓存..."
        rm -rf .next node_modules/.cache
        
        echo ""
        echo "✓ WASM 已禁用！"
        echo ""
        echo "启动命令：pnpm dev"
        ;;
        
    *)
        echo ""
        echo "无效的选项"
        exit 1
        ;;
esac

echo ""
echo "========================================="
echo "  完成后请访问 http://localhost:5000"
echo "========================================="
```

使用方法：

```bash
# 创建脚本
cat > fix-startup.sh << 'EOF'
[将上面的脚本内容粘贴到这里]
EOF

# 添加执行权限
chmod +x fix-startup.sh

# 运行脚本
./fix-startup.sh
```

---

## 🔍 验证修复

启动服务后，验证是否成功：

```bash
# 测试首页
curl http://localhost:5000

# 应该返回 HTML 内容
```

或访问浏览器：
- 主页：http://localhost:5000
- 测试页面：http://localhost:5000/test/encryption

---

## 📊 性能对比

| 方案 | 稳定性 | 性能 | 推荐度 |
|------|--------|------|--------|
| Next.js 15 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 强烈推荐 |
| Next.js 16 简化配置 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⚠️ 可用 |
| 禁用 WASM | ⭐⭐⭐⭐⭐ | ⭐⭐ | ❌ 不推荐 |

---

## 🆘 如果仍然无法解决

### 提供以下信息：

1. **Node.js 版本**：`node --version`
2. **pnpm 版本**：`pnpm --version`
3. **Next.js 版本**：`grep '"next"' package.json`
4. **完整的错误日志**：
   ```bash
   pnpm dev > error.log 2>&1 &
   cat error.log
   ```

### 获取帮助

- 查看故障排查指南：`故障排查指南.md`
- 查看项目文档：`PROJECT_GUIDE.md`
- 搜索 Next.js 16 相关问题

---

## 💡 推荐做法

**对于开发环境**：使用 **Next.js 15**，稳定可靠。

**对于生产环境**：
1. 先在 Next.js 15 中完成开发和测试
2. 等待 Next.js 16 稳定后再升级
3. 或使用 Docker 隔离环境

---

## 📝 总结

如果你遇到加载问题，**最简单的解决方案**是：

```bash
# 1. 降级 Next.js
sed -i 's/"next": "16.1.1"/"next": "15.1.6"/g' package.json

# 2. 重新安装
rm -rf node_modules pnpm-lock.yaml .next
pnpm install

# 3. 启动
pnpm dev
```

**这是最稳定可靠的解决方案！** ✅
