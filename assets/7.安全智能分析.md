åŸºäºå·²å®Œæˆçš„è®¤è¯ã€å®¡è®¡å’Œæƒé™ç³»ç»Ÿï¼Œè¯·æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§å®æ–½å®‰å…¨å¢å¼ºåŠŸèƒ½ï¼š

ã€ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³æ‰§è¡Œã€‘
1. åˆ›å»º SecurityAgent æœåŠ¡ï¼ˆlib/security/security-agent.tsï¼‰
   - åˆ†æå¼‚å¸¸ç™»å½•æ¨¡å¼ï¼ˆæš´åŠ›ç ´è§£ã€éå¸¸è§„æ—¶é—´ã€å¤šIPç™»å½•ï¼‰
   - åˆ†ææƒé™å¼‚å¸¸ï¼ˆé¢‘ç¹æƒé™æ‹’ç»ï¼‰
   - å­˜å‚¨å‘Šè­¦åˆ° security_alerts è¡¨

2. å®ç°å¼‚å¸¸å‘Šè­¦æœåŠ¡ï¼ˆlib/notification/alerter.tsï¼‰
   - æ”¯æŒé£ä¹¦å‘Šè­¦ï¼ˆwebhookï¼‰
   - æ”¯æŒé‚®ä»¶å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
   - é«˜å±å‘Šè­¦å®æ—¶æ¨é€

3. åˆ›å»ºå®‰å…¨ä»ªè¡¨ç›˜ï¼ˆapp/admin/security/page.tsxï¼‰
   - å®æ—¶å‘Šè­¦åˆ—è¡¨
   - ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»æ•°ã€é«˜å±ã€å¾…å¤„ç†ã€å·²è§£å†³ï¼‰
   - å‘Šè­¦ç¡®è®¤/å¤„ç†åŠŸèƒ½
   - å®æ—¶è®¢é˜…æ–°å‘Šè­¦å®‰å…¨æ™ºèƒ½åˆ†æ
1.1 SecurityAgent æœåŠ¡
è·¯å¾„: lib/security/security-agent.ts

typescript
import { createClient } from '@/lib/supabase/client'
import { AuditLogger } from '@/lib/supabase/audit-log'

export interface SecurityAlert {
  id: string
  type: 'bruteforce' | 'unusual_time' | 'multiple_ips' | 'permission_escalation'
  severity: 'low' | 'medium' | 'high' | 'critical'
  userId?: string
  email?: string
  ipAddress: string
  timestamp: Date
  details: any
  status: 'new' | 'acknowledged' | 'resolved'
}

export class SecurityAgent {
  private supabase = createClient()

  // 1. åˆ†æå¼‚å¸¸ç™»å½•æ¨¡å¼
  async analyzeLoginPatterns(): Promise<SecurityAlert[]> {
    const alerts: SecurityAlert[] = []
    
    // è·å–æœ€è¿‘1å°æ—¶çš„ç™»å½•å°è¯•
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000)
    const { data: attempts } = await this.supabase
      .from('login_attempts')
      select('*')
      .gte('created_at', oneHourAgo.toISOString())
      .order('created_at', { ascending: false })

    if (!attempts) return alerts

    // æ£€æµ‹1ï¼šæš´åŠ›ç ´è§£ï¼ˆåŒä¸€IPå¤šæ¬¡å¤±è´¥ï¼‰
    const ipFailCounts = new Map<string, number>()
    attempts.forEach(a => {
      if (!a.success) {
        ipFailCounts.set(a.ip_address, (ipFailCounts.get(a.ip_address) || 0) + 1)
      }
    })
    
    ipFailCounts.forEach((count, ip) => {
      if (count >= 10) { // 10æ¬¡å¤±è´¥/å°æ—¶
        alerts.push({
          id: `bf-${Date.now()}-${ip}`,
          type: 'bruteforce',
          severity: 'high',
          ipAddress: ip,
          timestamp: new Date(),
          details: { failureCount: count, timeWindow: '1å°æ—¶' },
          status: 'new'
        })
      }
    })

    // æ£€æµ‹2ï¼šéå¸¸è§„æ—¶é—´ç™»å½•ï¼ˆå‡Œæ™¨2-4ç‚¹ï¼‰
    const unusualHours = [2, 3, 4]
    attempts.forEach(a => {
      const hour = new Date(a.created_at).getHours()
      if (unusualHours.includes(hour) && a.success) {
        alerts.push({
          id: `ut-${Date.now()}-${a.user_id}`,
          type: 'unusual_time',
          severity: 'medium',
          userId: a.user_id,
          ipAddress: a.ip_address,
          timestamp: new Date(a.created_at),
          details: { loginTime: a.created_at },
          status: 'new'
        })
      }
    })

    // æ£€æµ‹3ï¼šåŒä¸€ç”¨æˆ·å¤šIPç™»å½•
    const userIPs = new Map<string, Set<string>>()
    attempts.forEach(a => {
      if (a.user_id && a.success) {
        if (!userIPs.has(a.user_id)) {
          userIPs.set(a.user_id, new Set())
        }
        userIPs.get(a.user_id)!.add(a.ip_address)
      }
    })
    
    userIPs.forEach((ips, userId) => {
      if (ips.size >= 3) { // åŒä¸€ç”¨æˆ·ä»3ä¸ªä¸åŒIPç™»å½•
        alerts.push({
          id: `mi-${Date.now()}-${userId}`,
          type: 'multiple_ips',
          severity: 'medium',
          userId,
          ipAddress: Array.from(ips).join(','),
          timestamp: new Date(),
          details: { ipCount: ips.size },
          status: 'new'
        })
      }
    })

    return alerts
  }

  // 2. åˆ†ææƒé™å¼‚å¸¸
  async analyzePermissionAnomalies(): Promise<SecurityAlert[]> {
    const alerts: SecurityAlert[] = []
    
    // è·å–æœ€è¿‘24å°æ—¶çš„å®¡è®¡æ—¥å¿—
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000)
    const { data: logs } = await this.supabase
      .from('audit_logs')
      .select('*')
      .eq('result', 'failure')
      .gte('created_at', oneDayAgo.toISOString())

    if (!logs) return alerts

    // æ£€æµ‹ï¼šé¢‘ç¹æƒé™æ‹’ç»
    const userDenials = new Map<string, number>()
    logs.forEach(log => {
      if (log.action.includes('update') || log.action.includes('delete')) {
        userDenials.set(log.user_id, (userDenials.get(log.user_id) || 0) + 1)
      }
    })

    userDenials.forEach((count, userId) => {
      if (count >= 5) { // 5æ¬¡æƒé™æ‹’ç»/å¤©
        alerts.push({
          id: `pe-${Date.now()}-${userId}`,
          type: 'permission_escalation',
          severity: 'high',
          userId,
          ipAddress: 'multiple',
          timestamp: new Date(),
          details: { denialCount: count, timeWindow: '24å°æ—¶' },
          status: 'new'
        })
      }
    })

    return alerts
  }

  // 3. è¿è¡Œå®Œæ•´åˆ†æ
  async runFullAnalysis(): Promise<{
    alerts: SecurityAlert[]
    summary: any
  }> {
    const loginAlerts = await this.analyzeLoginPatterns()
    const permissionAlerts = await this.analyzePermissionAnomalies()
    const allAlerts = [...loginAlerts, ...permissionAlerts]

    // å­˜å‚¨å‘Šè­¦
    if (allAlerts.length > 0) {
      await this.supabase.from('security_alerts').insert(
        allAlerts.map(a => ({
          type: a.type,
          severity: a.severity,
          user_id: a.userId,
          ip_address: a.ipAddress,
          details: a.details,
          status: 'new'
        }))
      )
    }

    return {
      alerts: allAlerts,
      summary: {
        total: allAlerts.length,
        critical: allAlerts.filter(a => a.severity === 'critical').length,
        high: allAlerts.filter(a => a.severity === 'high').length,
        medium: allAlerts.filter(a => a.severity === 'medium').length,
        low: allAlerts.filter(a => a.severity === 'low').length,
        timestamp: new Date()
      }
    }
  }
}
1.2 å¼‚å¸¸å‘Šè­¦æœåŠ¡ï¼ˆé‚®ä»¶/é£ä¹¦ï¼‰
è·¯å¾„: lib/notification/alerter.ts

typescript
interface AlertConfig {
  type: 'email' | 'feishu' | 'webhook'
  recipients?: string[]
  webhookUrl?: string
}

export class SecurityAlerter {
  private config: AlertConfig

  constructor(config: AlertConfig) {
    this.config = config
  }

  // å‘é€é£ä¹¦å‘Šè­¦
  async sendFeishu(alert: any) {
    const colors = {
      critical: 'red',
      high: 'orange',
      medium: 'yellow',
      low: 'blue'
    }

    const message = {
      msg_type: 'interactive',
      card: {
        config: { wide_screen_mode: true },
        header: {
          title: { tag: 'plain_text', content: `ğŸ”” å®‰å…¨å‘Šè­¦: ${alert.type}` },
          template: colors[alert.severity as keyof typeof colors] || 'blue'
        },
        elements: [
          {
            tag: 'div',
            text: { tag: 'lark_md', content: `**ä¸¥é‡çº§åˆ«**: ${alert.severity}` }
          },
          {
            tag: 'div',
            text: { tag: 'lark_md', content: `**æ—¶é—´**: ${alert.timestamp.toLocaleString()}` }
          },
          {
            tag: 'div',
            text: { tag: 'lark_md', content: `**IPåœ°å€**: ${alert.ipAddress}` }
          },
          {
            tag: 'div',
            text: { tag: 'lark_md', content: `**è¯¦æƒ…**:\n${JSON.stringify(alert.details, null, 2)}` }
          },
          {
            tag: 'action',
            actions: [
              {
                tag: 'button',
                text: { tag: 'plain_text', content: 'æŸ¥çœ‹è¯¦æƒ…' },
                url: `${process.env.NEXT_PUBLIC_APP_URL}/admin/security`,
                type: 'primary'
              }
            ]
          }
        ]
      }
    }

    await fetch(this.config.webhookUrl!, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(message)
    })
  }

  // å‘é€é‚®ä»¶å‘Šè­¦
  async sendEmail(alert: any) {
    // ä½¿ç”¨ nodemailer æˆ– Resend ç­‰æœåŠ¡
    // è¿™é‡Œç”¨ fetch è°ƒç”¨ä½ çš„é‚®ä»¶API
    await fetch('/api/notifications/email', {
      method: 'POST',
      body: JSON.stringify({
        to: this.config.recipients,
        subject: `[å®‰å…¨å‘Šè­¦] ${alert.type} - ${alert.severity}`,
        html: `
          <h2>å®‰å…¨å‘Šè­¦è¯¦æƒ…</h2>
          <p><strong>ç±»å‹:</strong> ${alert.type}</p>
          <p><strong>ä¸¥é‡çº§åˆ«:</strong> ${alert.severity}</p>
          <p><strong>æ—¶é—´:</strong> ${alert.timestamp}</p>
          <p><strong>IP:</strong> ${alert.ipAddress}</p>
          <p><strong>è¯¦æƒ…:</strong></p>
          <pre>${JSON.stringify(alert.details, null, 2)}</pre>
          <p><a href="${process.env.NEXT_PUBLIC_APP_URL}/admin/security">æŸ¥çœ‹è¯¦æƒ…</a></p>
        `
      })
    })
  }

  // å‘é€å‘Šè­¦
  async send(alert: any) {
    if (this.config.type === 'feishu' && this.config.webhookUrl) {
      await this.sendFeishu(alert)
    } else if (this.config.type === 'email' && this.config.recipients) {
      await this.sendEmail(alert)
    }
  }
}
1.3 å®‰å…¨ä»ªè¡¨ç›˜é¡µé¢
è·¯å¾„: app/admin/security/page.tsx

tsx
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Select } from '@/components/ui/select'
import { 
  Shield, 
  AlertTriangle, 
  Activity, 
  Clock,
  RefreshCw,
  CheckCircle,
  XCircle
} from 'lucide-react'
import { usePermission } from '@/hooks/usePermission'
import { SecurityAgent } from '@/lib/security/security-agent'
import { SecurityAlerter } from '@/lib/notification/alerter'

export default function SecurityDashboard() {
  const [alerts, setAlerts] = useState<any[]>([])
  const [summary, setSummary] = useState<any>(null)
  const [loading, setLoading] = useState(true)
  const [timeRange, setTimeRange] = useState('24h')
  const { can } = usePermission()
  const supabase = createClient()

  useEffect(() => {
    loadSecurityData()
    
    // å®æ—¶è®¢é˜…æ–°å‘Šè­¦
    const subscription = supabase
      .channel('security_alerts')
      .on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'security_alerts' },
        (payload) => {
          setAlerts(prev => [payload.new, ...prev])
        }
      )
      .subscribe()

    return () => {
      subscription.unsubscribe()
    }
  }, [timeRange])

  const loadSecurityData = async () => {
    setLoading(true)
    
    // è·å–å‘Šè­¦æ•°æ®
    const { data: alerts } = await supabase
      .from('security_alerts')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100)

    // è·å–ç»Ÿè®¡æ•°æ®
    const { data: stats } = await supabase
      .from('security_alerts')
      .select('severity, count')
      .group('severity')

    setAlerts(alerts || [])
    setSummary({
      total: alerts?.length || 0,
      bySeverity: stats || []
    })
    setLoading(false)
  }

  const runAnalysis = async () => {
    const agent = new SecurityAgent()
    const result = await agent.runFullAnalysis()
    
    // å‘é€å‘Šè­¦
    const alerter = new SecurityAlerter({
      type: 'feishu',
      webhookUrl: process.env.NEXT_PUBLIC_FEISHU_WEBHOOK
    })
    
    for (const alert of result.alerts) {
      if (alert.severity === 'high' || alert.severity === 'critical') {
        await alerter.send(alert)
      }
    }

    await loadSecurityData()
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'bg-red-500/20 text-red-300 border-red-500/30'
      case 'high': return 'bg-orange-500/20 text-orange-300 border-orange-500/30'
      case 'medium': return 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30'
      case 'low': return 'bg-blue-500/20 text-blue-300 border-blue-500/30'
      default: return 'bg-slate-500/20 text-slate-300 border-slate-500/30'
    }
  }

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'bruteforce': return <AlertTriangle className="w-4 h-4" />
      case 'unusual_time': return <Clock className="w-4 h-4" />
      case 'multiple_ips': return <Activity className="w-4 h-4" />
      case 'permission_escalation': return <Shield className="w-4 h-4" />
      default: return <AlertTriangle className="w-4 h-4" />
    }
  }

  if (!can('system', 'security')) {
    return <div className="p-6 text-white/60">æ— æƒè®¿é—®å®‰å…¨ä»ªè¡¨ç›˜</div>
  }

  return (
    <div className="p-6 space-y-6">
      {/* å¤´éƒ¨ */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-white">å®‰å…¨æ™ºèƒ½åˆ†æ</h1>
        <div className="flex items-center gap-3">
          <Select value={timeRange} onValueChange={setTimeRange}>
            <option value="1h">æœ€è¿‘1å°æ—¶</option>
            <option value="24h">æœ€è¿‘24å°æ—¶</option>
            <option value="7d">æœ€è¿‘7å¤©</option>
          </Select>
          <Button onClick={runAnalysis} disabled={loading}>
            <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
            è¿è¡Œåˆ†æ
          </Button>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-4 gap-4">
        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <Activity className="w-5 h-5 text-blue-400" />
              </div>
              <div>
                <p className="text-sm text-white/60">æ€»å‘Šè­¦æ•°</p>
                <p className="text-2xl font-bold text-white">{summary?.total || 0}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                <AlertTriangle className="w-5 h-5 text-red-400" />
              </div>
              <div>
                <p className="text-sm text-white/60">é«˜å±å‘Šè­¦</p>
                <p className="text-2xl font-bold text-white">
                  {summary?.bySeverity?.find((s: any) => s.severity === 'critical')?.count || 0}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                <Clock className="w-5 h-5 text-yellow-400" />
              </div>
              <div>
                <p className="text-sm text-white/60">å¾…å¤„ç†</p>
                <p className="text-2xl font-bold text-white">
                  {alerts.filter(a => a.status === 'new').length}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                <CheckCircle className="w-5 h-5 text-green-400" />
              </div>
              <div>
                <p className="text-sm text-white/60">å·²è§£å†³</p>
                <p className="text-2xl font-bold text-white">
                  {alerts.filter(a => a.status === 'resolved').length}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* å‘Šè­¦åˆ—è¡¨ */}
      <Card className="bg-slate-800/50 border-slate-700/50">
        <CardHeader>
          <CardTitle className="text-white">å®æ—¶å‘Šè­¦</CardTitle>
        </CardHeader>
        <CardContent className="p-0">
          <table className="w-full">
            <thead className="bg-slate-700/30">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">æ—¶é—´</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">ç±»å‹</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">ä¸¥é‡çº§åˆ«</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">IPåœ°å€</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">è¯¦æƒ…</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">çŠ¶æ€</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-white/60">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-700/50">
              {alerts.map(alert => (
                <tr key={alert.id} className="hover:bg-slate-700/20">
                  <td className="px-4 py-3 text-sm text-white/80">
                    {new Date(alert.created_at).toLocaleString()}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      {getTypeIcon(alert.type)}
                      <span className="text-sm text-white/80">{alert.type}</span>
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <Badge variant="outline" className={getSeverityColor(alert.severity)}>
                      {alert.severity}
                    </Badge>
                  </td>
                  <td className="px-4 py-3 text-sm text-white/60">{alert.ip_address}</td>
                  <td className="px-4 py-3 text-sm text-white/60">
                    {alert.details?.failureCount ? `${alert.details.failureCount}æ¬¡å¤±è´¥` : 
                     alert.details?.ipCount ? `${alert.details.ipCount}ä¸ªIP` : '-'}
                  </td>
                  <td className="px-4 py-3">
                    <Badge variant="outline" className={
                      alert.status === 'new' ? 'border-yellow-500/30 text-yellow-400' :
                      alert.status === 'acknowledged' ? 'border-blue-500/30 text-blue-400' :
                      'border-green-500/30 text-green-400'
                    }>
                      {alert.status}
                    </Badge>
                  </td>
                  <td className="px-4 py-3">
                    <Button 
                      variant="ghost" 
                      size="sm"
                      onClick={() => {
                        supabase
                          .from('security_alerts')
                          .update({ status: 'acknowledged' })
                          .eq('id', alert.id)
                          .then(() => loadSecurityData())
                      }}
                    >
                      ç¡®è®¤
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </CardContent>
      </Card>

      {/* å®‰å…¨æ€åŠ¿å›¾ */}
      <div className="grid grid-cols-2 gap-4">
        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardHeader>
            <CardTitle className="text-white">å‘Šè­¦è¶‹åŠ¿</CardTitle>
          </CardHeader>
          <CardContent className="h-64">
            {/* è¿™é‡Œå¯ä»¥é›†æˆEChartså±•ç¤ºè¶‹åŠ¿å›¾ */}
          </CardContent>
        </Card>

        <Card className="bg-slate-800/50 border-slate-700/50">
          <CardHeader>
            <CardTitle className="text-white">å‘Šè­¦åˆ†å¸ƒ</CardTitle>
          </CardHeader>
          <CardContent className="h-64">
            {/* è¿™é‡Œå¯ä»¥é›†æˆEChartså±•ç¤ºé¥¼å›¾ */}
          </CardContent>
        </Card>
      </div>
    </div>
  )
}